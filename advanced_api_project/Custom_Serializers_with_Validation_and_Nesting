from rest_framework import serializers
from django.utils import timezone
from .models import Author, Book

# Step 4: Create Custom Serializers
# Step 5: Document Model and Serializer Setup

class BookSerializer(serializers.ModelSerializer):
    """
    Serializer for the Book model.
    Includes custom validation to ensure publication year is not in the future.
    """
    class Meta:
        model = Book
        fields = ('id', 'title', 'publication_year', 'author')
        read_only_fields = ('author',) # 'author' will be set by the parent serializer

    def validate_publication_year(self, value):
        """
        Validation Requirements: Ensures the publication_year is not in the future.
        """
        current_year = timezone.now().year
        if value > current_year:
            raise serializers.ValidationError(
                f"Publication year cannot be in the future. Current year is {current_year}."
            )
        return value

class AuthorSerializer(serializers.ModelSerializer):
    """
    Serializer for the Author model.
    It includes a nested BookSerializer to display all related books for an Author.
    
    Relationship Handling:
    - The 'books' field is defined using BookSerializer(many=True). 
    - It uses the 'related_name' ('books') defined on the Book model's ForeignKey 
      field to automatically retrieve all associated Book instances when serializing an Author.
    - When creating/updating an Author and their Books simultaneously, this nesting 
      allows for complex data input (Write-side functionality).
    """
    # Nested BookSerializer: This field will list all books associated with the author.
    books = BookSerializer(many=True, read_only=True) 

    class Meta:
        model = Author
        fields = ('id', 'name', 'books')
        
    # --- Alternative for Write Operations (if books needed to be created/updated with author) ---
    # For simplicity, and meeting the objective of *nested serialization*, we use 
    # read_only=True above. For a writable nested serializer, the implementation 
    # of the create() and update() methods would be required.
    # e.g., books = BookSerializer(many=True, required=False)